<dom-module id="core9-fileeditor">
<style>
:host {
	display: -webkit-box;
	display: -moz-box;
	display: -ms-flexbox;
	display: -webkit-flex;
	display: flex;
}

#menutree {
	margin-left: 50px;
	margin-top: 45px;
}

#menutree li {
	list-style: none;
	margin-left: -20px;
}

li .menu_label+input[type="checkbox"] {
	opacity: 0;
	display: none;
}

li .menu_label {
	cursor: pointer;
}

li .menu_label+input[type="checkbox"]+ol>li {
	display: none;
}

li .menu_label+input[type="checkbox"]:checked+ol>li {
	display: block;
}

li.page a {
	padding-left: 20px;
	text-decoration: none;
	display: block;
	background: url(img/document.png) 0px 0px no-repeat;
}

li.page a[href*=".pdf"] {
	background: url(img/document.png) 0px 0px no-repeat;
}

li.page a[href*=".html"] {
	background: url(img/document.png) 0px 0px no-repeat;
}

li.page a[href$=".css"] {
	background: url(img/document.png) 0px 0px no-repeat;
}

li.page a[href$=".js"] {
	background: url(img/document.png) 0px 0px no-repeat;
}

li label {
	cursor: pointer;
	display: block;
	padding-left: 20px;
	background: url(img/folder-horizontal.png) 0px 1px no-repeat;
}

.selected {
	color: red;
}

#workspace {
	position: absolute;
	left: 40px;
	width: 100%;
	height: calc(100% - 30px);
	background-color: #f0f0f0;
}

juicy-ace-editor {
	width: 100%;
	height: calc(100% - 20px);
	position: relative;
}

#top-menu li {
	display: inline;
	list-style-type: none;
	padding-right: 20px;
	padding-top: 2px;
	padding-bottom: 2px;
}
</style>
<template>

<ol id="menutree">
	<li><label class="menu_label" for="c1">Menu Gen14 Am0a1</label> <input
		type="checkbox" id="c1" /> <!-- input must follow label for safari -->
		<ol>
			<li><label for="c2" class="menu_label">Menu Am1a1</label> <input
				type="checkbox" id="c2" />
				<ol>
					<li class="page"><a href="#">Page Ap1a1</a></li>
					<li class="page"><a href="#">Page Ap1a2</a></li>
					<li class="page"><a href="#">Page Ap1a3</a></li>
				</ol></li>
			<li><label for="c3" class="menu_label">Menu Am1b1</label> <input
				type="checkbox" id="c3" />
				<ol>
					<li class="page"><a href="#">Page Ap1b1</a></li>

					<li><label for="c4" class="menu_label">Menu Am2b1 </label> <input
						type="checkbox" id="c4" />
						<ol>
							<li class="page"><a href="#">Page Ap2b1</a></li>
						</ol></li>
				</ol></li>
		</ol></li>
	<li><label class="menu_label" for="c5">Menu Bm0a1</label> <input
		type="checkbox" id="c5" />
		<ol>
			<li><label for="c6" class="menu_label">Menu Bm1a1</label> <input
				type="checkbox" id="c6" />
				<ol>
					<li class="page"><a href="#">Page Bp1a1</a></li>
				</ol></li>
			<li><label for="c7" class="menu_label">Menu Bm1b1</label> <input
				type="checkbox" id="c7" />
				<ol>
					<li class="page"><a href="#">Page Bp1b1</a></li>
					<li><label for="c8" class="menu_label">Menu Bm2b1</label> <input
						type="checkbox" id="c8" />
						<ol>
							<li class="page"><a href="#">Page Bp2b1</a></li>
						</ol></li>
				</ol></li>
		</ol></li>
</ol>

<div id="workspace">
	<ul id="top-menu">
		<li><a id="showmenu" href="javascript:void(0);">files</a></li>
		<li></li>
		<li>Filename :</li>
		<li><input type="text" name="filename" value="name"></li>
	</ul>

	<juicy-ace-editor>Editable code here</juicy-ace-editor>

</div>



<content id="content"></content> </template> </dom-module>


<script>
	if (typeof Core9 === 'undefined') {
		Core9 = {}
	};
	if (typeof Core9.menu === 'undefined') {
		Core9.menu = {}
	};
	Core9.menu.contextId = "context-menu";
	Core9.menu.getHostElement = function(element) {
		while (element.nodeType != 11) { // 11 = DOCUMENT_FRAGMENT_NODE
			element = element.parentNode;
		}
		return element.host;
	}

	Core9.menu.removeElement = function(element) {
		if (element.parentNode) {
			element.parentNode.removeChild(element);
		}
	}

	Core9.menu.getMouseLocation = function(e) {
		var evt = e ? e : window.event;
		var clickX = 0, clickY = 0;
		if ((evt.clientX || evt.clientY) && document.body
				&& document.body.scrollLeft != null) {
			clickX = evt.clientX + document.body.scrollLeft;
			clickY = evt.clientY + document.body.scrollTop;
		}
		if ((evt.clientX || evt.clientY) && document.compatMode == 'CSS1Compat'
				&& document.documentElement
				&& document.documentElement.scrollLeft != null) {
			clickX = evt.clientX + document.documentElement.scrollLeft;
			clickY = evt.clientY + document.documentElement.scrollTop;
		}
		if (evt.pageX || evt.pageY) {
			clickX = evt.pageX;
			clickY = evt.pageY;
		}
		return {
			pageX : clickX,
			pageY : clickY,
			clientX : evt.clientX,
			clientY : evt.clientY,
			screenX : evt.screenX,
			screenY : evt.screenY,
		}
	}

	Core9.menu.addClickEvent = function(elements, event, callback) {
		for (var int = 0; int < elements.length; int++) {
			elements[int].addEventListener(event, callback);
		}
	}

	Core9.menu.itemsFromJson = function(jsonItems) {
		var ul = document.createElement('ul');
		for (var int = 0; int < jsonItems.items.length; int++) {
			var item = document.createElement('li');
			item.appendChild(document.createTextNode(jsonItems.items[int][0]));
			item.addEventListener('click', jsonItems.items[int][1]);
			ul.appendChild(item);
		}
		return ul;
	}

	Core9.menu.contextMenu = function(event, jsonItems) {
		var host = Core9.menu.getHostElement(event.target).shadowRoot;
		if (host.getElementById(Core9.menu.contextId) === null) {
			Core9.menu.show(event.target, document.createElement('div'),
					jsonItems);
		} else {
			Core9.menu.removeElement(host.querySelector('#'
					+ Core9.menu.contextId));
		}
	}

	Core9.menu.show = function(element, menu, jsonItems) {
		var mouse = Core9.menu.getMouseLocation(event);
		menu
				.setAttribute(
						"style",
						"left:"
								+ mouse.pageX
								+ "px;top:"
								+ (mouse.pageY + 10)
								+ "px;width: 200px;height: 300px;background-color:red;position:absolute;z-index: 99999;");
		menu.setAttribute("id", Core9.menu.contextId);
		menu.appendChild(Core9.menu.itemsFromJson(jsonItems));
		Core9.menu.getHostElement(element).shadowRoot.appendChild(menu);
	}

	Core9.menu.initMenu = function(e) {
		var selectedElements = Core9.menu.getHostElement(e.target).$.menutree
				.querySelectorAll('.selected');
		if (selectedElements != null) {
			for (var int = 0; int < selectedElements.length; int++) {
				selectedElements[int].className = selectedElements[int].className
						.replace(' selected', '');
			}
		}

		var element = e.target;
		element.className = element.className + " selected";

		var callback = function() {
			console.log('click on context menu :');
			console.log(this);
			console.log('for element : ');
			var selectedElements = Core9.menu.getHostElement(this).$.menutree
					.querySelector('.selected');
			console.log(selectedElements);
			console.log(selectedElements.getElementsByTagName("ol"));
		}

		var jsonItems = {}
		if (e.target.nodeName === 'A') {
			jsonItems = {
				items : [ [ 'edit', callback ], [ 'rename', callback ],
						[ 'delete', callback ] ]
			}
		} else {
			jsonItems = {
				items : [ [ 'new file', callback ], [ 'new folder', callback ],
						[ 'edit', callback ] ]
			}
		}

		Core9.menu.contextMenu(e, jsonItems);
		e.preventDefault();
		return false;
	}

	Core9.menu.handleClickMenu = function(e) {
		if (e.target.nodeName === 'A') {
			e.preventDefault();
			return false;
		}
	}

	Core9.menu.showFileBrowser = function(e) {
		var workspace = Core9.menu.getHostElement(e.target).$.workspace;
		var left = workspace.getBoundingClientRect().left;
		if (left > 300) {
			workspace.style.left = "40px"
		} else {
			workspace.style.left = "301px"
		}
		return false;
	}

	Core9.menu.init = function(modules) {

		var DB = Core9.system.unwrapModule(modules[0]);

		"use strict";
		Polymer({
			is : 'core9-fileeditor',
			ready : function() {

				//console.log(DB.config);

				Core9.menu.addClickEvent(this.$.menutree
						.querySelectorAll(".menu_label"), 'click',
						Core9.menu.handleClickMenu);
				Core9.menu.addClickEvent(this.$.menutree.querySelectorAll("a"),
						'click', Core9.menu.handleClickMenu);
				Core9.menu.addClickEvent(this.$.menutree
						.querySelectorAll(".menu_label"), 'contextmenu',
						Core9.menu.initMenu);
				Core9.menu.addClickEvent(this.$.menutree.querySelectorAll("a"),
						'contextmenu', Core9.menu.initMenu);

				this.$.showmenu.addEventListener('click',
						Core9.menu.showFileBrowser);

			}
		});
	}
	Core9.system.multiImport([ 'app/elements/core9-core/js/core-db' ]).then(
			function(modules) {
				Core9.menu.init(modules);
			});
</script>
