<!DOCTYPE html>
<!--[if lt IE 7]>
<html lang="en" class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html lang="en" class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html lang="en" class="lt-ie9"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html lang="en">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
	<title>Themes</title>
	<link rel="stylesheet" href="/dashboard/bower_components/select2/dist/css/select2.min.css">
	<link rel="stylesheet" href="/dashboard/bower_components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="/dashboard/bower_components/nestable2/jquery.nestable.css">
	<link rel="stylesheet" href="/dashboard/panels/themes/style.css">

	<script src="/dashboard/bower_components/store-js/store.min.js"></script>
	<script src="/dashboard/bower_components/lokijs/build/lokijs.min.js"></script>
	<script type="text/javascript" src="/dashboard/app/elements/core9-core/js/iframe/child.js"></script>
	<script src="/dashboard/bower_components/jquery/dist/jquery.min.js"></script>
	<script src="/dashboard/bower_components/nestable2/jquery.nestable.js"></script>
	<script src="/dashboard/bower_components/select2/dist/js/select2.full.min.js"></script>
	<script src="/dashboard/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="/dashboard/bower_components/json-editor/dist/jsoneditor.min.js"></script>
	<script type="text/javascript">
		var guid = function() {
			function s4() {
				return Math.floor((1 + Math.random()) * 0x10000).toString(16)
					.substring(1);
			}
			return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
		}
	</script>
	<script>
		var THEMEDATA = null;
		var pageInit = true;
		var DB = new loki();
		var dbEntries = DB.addCollection('themeentries');
	</script>
</head>

<body>

	<div id="choose-theme">
		<div id="theme-modal">
			<div id="exit-modal" style="float:right;">x</div>
			<div id="choose-theme-template-page"></div>
			<select class="choose-theme-select"></select>
			<button id="edit-selected-theme">edit</button>
		</div>
	</div>


	<div id="content" class="cf nestable-lists">

		<div style="width: 100%;" class="btn-group" role="group" aria-label="" style="width: 500px; left: 195px; top: -34px;">
			<h1 style="margin-top: 10px; font-size: 16px;">Templates</h1>
			<ul id="navlist">
				<li style="width: 263px !important; height: 40px;">
					<select class="template-data"></select>
				</li>
				<li style="width: 98px !important; height: 40px;">
					<select class="language-data"></select>
				</li>
				<li style="width: 98px !important; height: 40px;">
					<select class="country-data"></select>
				</li>
				<li style="width: 10px !important; height: 40px; padding-left: 0px;">
					<a id="refresh-templates" href="#" class="btn glyphicon glyphicon-refresh" role="button">&nbsp;</a>
				</li>
				<li style="width: 300px !important; height: 40px; padding-left: 57px;">
					<a href="#" class="btn btn-primary" role="button">New Theme</a>
				</li>
			</ul>


		</div>



		<div id="menuitemcontent">
			<div class="btn-group" role="group" aria-label="" style="width: 500px;">
				<button type="button" class="btn btn-default">Preview</button>
				<button id="editpage" type="button" class="btn btn-default">Edit</button>
				<button id="newpage" type="button" class="btn btn-default">New</button>
				<button id="delpage" type="button" class="btn btn-default">Delete</button>
			</div>





			<div id='editor_holder2'></div>
			<button id='submit'>Save</button>
			<button id='restore'>Restore</button>
			<span id='valid_indicator'></span>

		</div>
		<div id="nestablecontainer">
			<div class="dd" id="nestable"></div>
		</div>


	</div>


	<script>
		if (typeof Core9 === 'undefined') {
			Core9 = {}
		};
		Core9.editor = {};

		var starting_value = [{
			title: "new title",
			percentage: 100,
			status: "active"
		}];

		var getArray = function(nr) {
			return Array.apply(null, {
				length: nr
			}).map(Number.call, Number)
		}

		var activateEditor = function(page, id, pageData) {
			console.log(pageData);
			document.getElementById('delpage').dataset.currentid = id;
			try {
				Core9.editor.destroy();
			} catch (e) {
				// TODO: handle exception
			}

			var starting_value = pageData.versions;

			$('#choose-theme-template-page').html(page);


			Core9.editor = new JSONEditor(document
				.getElementById('editor_holder2'), {
					ajax: true,
					disable_edit_json: true,
					disable_collapse: true,
					disable_properties: true,
					format: 'grid',
					theme: 'bootstrap3',
					startval: starting_value,
					no_additional_properties: true,
					required_by_default: true,
					schema: {
						type: "array",
						title: page,
						format: "tabs",
						items: {
							title: "Version",
							headerTemplate: "{{i}} - {{self.title}}",
							type: "object",
							id: "templateid",
							properties: {
								"title": {
									"type": "string",
									"minLength": 4
								},
								"status": {
									"type": "string",
									"enum": ["active", "pauzed"]
								}
							}
						}
					}
				});

			Core9.editor.on('change', function() {
				var errors = Core9.editor.validate();

				var indicator = document.getElementById('valid_indicator');

				if (errors.length) {
					indicator.style.color = 'red';
					indicator.textContent = "not valid";
				} else {
					indicator.style.color = 'green';
					indicator.textContent = "valid";
				}
			});

			document.getElementById('submit').addEventListener('click',
				function() {
					console.log(Core9.editor.getValue());
				});

			document.getElementById('restore').addEventListener('click',
				function() {
					Core9.editor.setValue(starting_value);
				});

		}

		var getSelectBoxEntries = function(page) {
			var template = $(".template-data").val();
			var language = $(".language-data").val();
			var country = $(".country-data").val();
			if (country == null) {
				country = ""
			}
			var query = {
				"template": template,
				"language": language,
				"country": country
			}
			if (page) {
				query.page = page;
			}
			return dbEntries.findObjects(query);
		}

		var postClick = function(url) {
			Core9.iframe.child.sentMessageToParent({
				action: "menuClick",
				href: url,
				data: ""
			});
		}

		function changeSelect2Data(className, dataCategory) {
			$("." + className).select2({
				data: dataCategory
			});
		}

		$(document)
			.ready(
				function() {

					$('#edit-selected-theme').on('click', function() {
						var dropdown = $('.choose-theme-select').val();
						console.log(dropdown);
						var account = store.get('account');
						var page = $('#choose-theme-template-page').html();
						var template = '/dashboard/data/accounts/' + account + '/themes/bower_components/' + $(".template-data").val() + '/templates/pages/' + page + '/versions/' + dropdown + '/index.html'
						template = template.toLowerCase();
						store.set('template', template);
						console.log(store.get('template'));
						history.pushState(null, null, "/dashboard/theme/edit");
						postClick("/dashboard/theme/edit");
					});

					$('#exit-modal').on('click', function() {
						$('#choose-theme').toggle();
					});

					$('#editpage').on('click', function() {
						$('#choose-theme').toggle();
						var versions = Core9.editor.getValue();
						var activeVersions = [];
						for (var i = 0; i < versions.length; i++) {
							var status = versions[i].status;
							if (status == 'active') {
								activeVersions.push(versions[i].title);
							}
						}
						changeSelect2Data("choose-theme-select", activeVersions);
					});



					$('#refresh-templates').on('click', function() {

						var entries = getSelectBoxEntries();
						var data = [];
						for (i = 0; i < entries.length; i++) {
							var item = {
								"id": guid(),
								"page": entries[i].page
							}
							data.push(item);
						}
						initNestable(JSON.stringify(data));
					});

					$('#newpage').on(
						'click',
						function() {
							var content = $('#nestable').nestable(
								'serialize');
							var json = content; //JSON.parse(jsonStr);
							json.unshift({
								"id": guid(),
								"page": "New Page"
							});
							initNestable(JSON.stringify(json));
						});

					$('#delpage')
						.on(
							'click',
							function() {
								$(
										'li[data-id="' + this.dataset.currentid + '"]')
									.remove();
							});
				});


		var getIdFromItem = function(element) {
			while (element.parentNode) {
				element = element.parentNode;
				if (element.tagName == 'LI') {
					return element.dataset.id;
				}
			}
		}

		var updateOutput = function() {
			var content = $('#nestable').nestable(
				'serialize');
			console.log(content);
			console.log(JSON.stringify(content));
		}



		function arrayContains(needle, arrhaystack) {
			return (arrhaystack.indexOf(needle) > -1);
		}

		function isEmpty(str) {
			return (!str || 0 === str.length);
		}

		var initTemplateSelectBoxes = function(themeData) {

			var templateData = {
				data: [""]
			}

			for (var key in themeData) {
				if (themeData.hasOwnProperty(key)) {
					templateData.data.push(key);
					try {
						var entries = themeData[key].data.templates[key].entries;
						for (i = 0; i < entries.length; i++) {
							entries[i]["template"] = key;
							dbEntries.insert(entries[i]);
						}
					} catch (e) {
						//console.log(e);
					}

				}
			}



			$(".template-data").on("change", function() {
				$(".language-data").select2("destroy");
				$(".language-data").html("<option><option>");
				var data = [];
				var entries = dbEntries.find({
					"template": $(this).val()
				});
				for (i = 0; i < entries.length; i++) {
					var lang = entries[i]['language'];
					if (!arrayContains(lang, data) && !isEmpty(lang)) {
						data.push(lang);
					}
				}
				changeSelect2Data("language-data", data);
			});

			$(".language-data").on("change", function() {
				$(".country-data").select2("destroy");
				$(".country-data").html("<option><option>");
				var data = [];
				var entries = dbEntries.find({
					"template": $(".template-data").val(),
					"language": $(this).val()
				});
				for (i = 0; i < entries.length; i++) {
					var country = entries[i]['country'];
					if (!arrayContains(country, data) && !isEmpty(country)) {
						data.push(country);
					}
				}
				changeSelect2Data("country-data", data);
			});

			changeSelect2Data("template-data", templateData["data"]);
			changeSelect2Data("language-data", []);
			changeSelect2Data("country-data", []);

		}

		var initNestable = function(jsonStr, themeData) {
			if (themeData != null && pageInit) {
				THEMEDATA = themeData;
				initTemplateSelectBoxes(themeData);
				pageInit = false;
			}

			var container = document
				.getElementById('nestablecontainer');
			while (container.firstChild)
				container.removeChild(container.firstChild);
			var div = document.createElement('div');
			div.id = 'nestable';
			div.className = 'dd';
			container.appendChild(div);

			$('#nestable')
				.nestable({
					group: 1,
					maxDepth: 20,
					json: jsonStr,
					contentCallback: function(
						item) {
						var content = item.page || '' ? item.page : item.id;
						content += '<div class="dd-handle dd3-handle">Drag</div>';

						return content;
					},
					callback: function(l, e) {
						var element = $(e[0])
							.find(
								'.dd-content')[0].childNodes[0];
						var page = element.textContent;
						activateEditor(
							page,
							getIdFromItem(element),
							getSelectBoxEntries(page)[0] // get only one sorry
						);
					}
				}).on('change', updateOutput);
		}
	</script>
	<script>
		var callback = function(event) {
			try {
				eval(event.data);
			} catch (e) {}
		}
		Core9.iframe.child.listenToPostMessages(callback);
	</script>
</body>

</html>
